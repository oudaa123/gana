<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø³Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø­Ù„Ø§Øª</title>

  <style>
    :root{
      --bg: #e8f5e9;
      --card: #ffffff;
      --green: #2e7d32;
      --btn-light: #c8e6c9;
      --btn-hover: #a5d6a7;
      --muted: #666;
      --warning: #ffb300;
      --danger: #ef5350;
      --success: #4caf50;
    }

    body {
      font-family: "Tahoma", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 12px;
      -webkit-font-smoothing:antialiased;
      transition: background 0.3s;
    }

    .container {
      max-width: 980px;
      margin: auto;
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    h1 {
      text-align: center;
      color: var(--green);
      margin: 6px 0 15px 0;
      font-size: 22px;
    }

    .top-row {
      display:flex;
      gap:8px;
      justify-content:flex-start;
      align-items:center;
      margin-bottom:12px;
      flex-wrap: wrap;
    }

    .top-row button {
      padding:8px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:700;
      transition: all 0.2s;
      font-size: 14px;
    }

    .export { background:#81c784;color:#fff }
    .export:hover { background:#66bb6a; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .clear  { background:var(--danger);color:#fff }
    .clear:hover { background:#e53935; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .filter { background:#42a5f5;color:#fff }
    .filter:hover { background:#2196f3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .left {
      width: 100%;
    }

    .right {
      width: 100%;
    }

    .section-title {
      color: var(--green);
      margin: 6px 0;
      font-weight:700;
      font-size:16px;
    }

    .category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .category-tab {
      padding: 8px 12px;
      background: #e0f2f1;
      border: 1px solid #80cbc4;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .category-tab.active {
      background: var(--green);
      color: white;
      border-color: var(--green);
    }

    .category-tab:hover:not(.active) {
      background: #b2dfdb;
    }

    .buttons-area {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:10px;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
    }

    .item-btn {
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: var(--btn-light);
      border:1px solid #81c784;
      color:var(--green);
      padding:10px;
      border-radius:10px;
      font-size:16px;
      cursor:pointer;
      transition:0.15s;
    }
    .item-btn:hover { 
      background: var(--btn-hover); 
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .item-btn.selected {
      background: var(--green);
      color: white;
      border-color: var(--green);
    }

    .small-btn {
      background:var(--danger);
      color:#fff;
      border:none;
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      margin-left:8px;
      transition: all 0.2s;
      font-size: 12px;
    }
    .small-btn:hover { background:#e53935; transform: scale(1.05); }
    .small-btn.edit { background:var(--warning); }
    .small-btn.edit:hover { background:#ffa000; transform: scale(1.05); }

    .add-row {
      display:flex;
      gap:8px;
      margin-top:8px;
      flex-direction: column;
    }

    .add-row input {
      flex:1;
      padding:8px;
      border-radius:8px;
      border:1px solid #bbb;
      font-size:14px;
      transition: all 0.2s;
    }

    .add-row input:focus {
      border-color: var(--green);
      outline: none;
      box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
    }

    .add-row button {
      padding:8px 12px;
      border-radius:8px;
      border:none;
      background:var(--green);
      color:white;
      cursor:pointer;
      font-weight:700;
      transition: all 0.2s;
      font-size: 14px;
    }
    .add-row button:hover { background:#1b5e20; transform: translateY(-2px); }

    label { display:block; margin-top:8px; font-weight:700; color:#2b2b2b; font-size: 14px; }
    input[type="text"], input[type="number"] {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
      box-sizing:border-box;
      transition: all 0.2s;
    }
    input:focus {
      border-color: var(--green);
      outline: none;
      box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
      transform: scale(1.01);
    }

    .save-row { display:flex; gap:8px; margin-top:10px; flex-direction: column; }
    .save-row button {
      flex:1;
      padding:12px;
      border-radius:10px;
      border:none;
      font-size:14px;
      cursor:pointer;
      font-weight:700;
      background: var(--btn-light);
      color:var(--green);
      transition: all 0.2s;
    }
    .save-row button:hover { background: var(--btn-hover); transform: translateY(-2px); }
    .save-row button.save { background: var(--success); color: white; }
    .save-row button.save:hover { background: #388e3c; transform: translateY(-2px); }
    .save-row button.cancel { background: var(--danger); color: white; }
    .save-row button.cancel:hover { background: #e53935; transform: translateY(-2px); }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      direction: rtl;
      font-size:14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border:1px solid #dfe;
      padding:8px 6px;
      text-align:center;
      transition: background 0.3s;
    }
    th {
      background:#dcedc8;
      color:var(--green);
      font-weight:800;
    }
    
    tr:hover td {
      background-color: #f0f8ff;
    }

    .action-btn {
      padding:6px 8px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      margin:0 4px;
      transition: all 0.2s;
    }
    .action-btn:hover {
      transform: scale(1.05);
    }
    .action-edit { background:var(--warning); color:#fff; }
    .action-edit:hover { background:#ffa000; }
    .action-del  { background:var(--danger); color:#fff; }
    .action-del:hover { background:#e53935; }

    .filter-section {
      margin-bottom: 15px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    
    .filter-row input, .filter-row select {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      transition: all 0.2s;
    }
    
    .filter-row input:focus {
      border-color: var(--green);
      outline: none;
      box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 80%;
    }
    
    .notification.success { background: var(--success); }
    .notification.error { background: var(--danger); }
    .notification.warning { background: var(--warning); color: #333; }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-style: italic;
    }
    
    .stats {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    .stat-box {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 100px;
      transition: all 0.3s;
    }
    
    .stat-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: var(--green);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© ÙˆØ§Ù„ÙƒØ¨ÙŠØ±Ø© */
    @media(min-width: 768px) {
      body {
        padding: 18px;
      }
      
      .container {
        padding: 18px;
      }
      
      h1 {
        font-size: 26px;
      }
      
      .top-row button {
        font-size: 16px;
      }
      
      .layout {
        flex-direction: row;
      }
      
      .left {
        width: 36%;
      }
      
      .right {
        width: 64%;
      }
      
      .add-row {
        flex-direction: row;
      }
      
      .save-row {
        flex-direction: row;
      }
      
      .filter-row {
        flex-direction: row;
      }
      
      .category-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      
      .stat-box {
        min-width: 120px;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      .stat-label {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø³Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø­Ù„Ø§Øª</h1>

    <div class="top-row">
      <button id="exportCsv" class="export">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>
      <button id="clearAll" class="clear">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      <button id="toggleFilter" class="filter">ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
    </div>

    <div class="stats" id="statsContainer"></div>

    <div class="layout">
      <div class="left">
        <div>
          <div class="section-title">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
          
          <div class="category-tabs" id="categoryTabs"></div>
          
          <div id="itemsArea" class="buttons-area"></div>

          <div class="add-row" style="margin-top:8px">
            <input id="newItemInput" placeholder="Ø£Ø¶Ù ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©">
            <button id="addItemBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #e0f0e0"/>

        <div>
          <div class="section-title">ğŸª Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
          <div id="shopsArea" class="buttons-area"></div>

          <div class="add-row" style="margin-top:8px">
            <input id="newShopInput" placeholder="Ø£Ø¶Ù Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©">
            <button id="addShopBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
      </div>

      <div class="right">
        <div id="filterSection" class="filter-section" style="display: none;">
          <div class="section-title">ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
          <div class="filter-row">
            <input type="text" id="filterItem" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙ†Ù">
            <input type="text" id="filterShop" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø­Ù„">
            <input type="number" id="filterQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button id="applyFilter" class="small-btn" style="background: var(--green)">ØªØ·Ø¨ÙŠÙ‚</button>
            <button id="clearFilter" class="small-btn">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>

        <div>
          <label>ğŸ“¦ Ø§Ù„ØµÙ†Ù</label>
          <input id="entry_item" type="text" placeholder="Ø§Ø®ØªØ± ØµÙ†Ù Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ø§ÙƒØªØ¨">

          <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="entry_qty" type="number" min="1" value="1">

          <label>ğŸª Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</label>
          <input id="entry_shop" type="text" placeholder="Ø§Ø®ØªØ± Ù…Ø­Ù„ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ø§ÙƒØªØ¨">

          <div class="save-row">
            <button id="saveBtn" class="save">ğŸ’¾ Ø­ÙØ¸</button>
            <button id="saveNewBtn">ğŸ’¾â• Ø­ÙØ¸ + Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="section-title">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>

          <table id="recordsTable">
            <thead>
              <tr>
                <th>ğŸ•’ Ø§Ù„ÙˆÙ‚Øª</th>
                <th>ğŸ“¦ Ø§Ù„ØµÙ†Ù</th>
                <th>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>ğŸª Ø§Ù„Ù…Ø­Ù„</th>
                <th>âš¡ Ø£Ø­Ø¯Ø§Ø«</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

  <div id="notification" class="notification"></div>

<script>
  // Storage keys
  const KEY_ITEMS = 'selaf_items_list_v3';
  const KEY_SHOPS = 'selaf_shops_list_v3';
  const KEY_DATA  = 'selaf_records_data_v3';
  const KEY_CATEGORIES = 'selaf_categories_v3';

  // Default categories and items
  const defaultCategories = {
    "Ø¬Ø±Ø§Ø¨Ø§Øª": [
      "Ø¬Ø±Ø§Ø¨ Ù„Ø¨ÙˆØ¨Ùˆ Ø­Ø±ÙŠÙ…ÙŠ", "Ø¬Ø±Ø§Ø¨ ÙØ±Ø§Ø´Ù‡ Ø¬Ø¯ÙŠØ¯", "Ø¬Ø±Ø§Ø¨ Ù…ÙØ­Ù… Ø§Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙØ±ÙŠ", 
      "Ø¬Ø±Ø§Ø¨ Ù…ÙØ­Ù… Ø§ÙŠÙÙˆÙ† Ø¨Ø§ÙƒÙŠØª Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ", "Ø¬Ø±Ø§Ø¨ Ø¬Ù„Ø¯ Ù…ØµØ±ÙŠ", "Ø¬Ø±Ø§Ø¨ Ø¬Ù„Ø¯ Ø§Ù„Ùƒ", 
      "Ø¬Ø±Ø§Ø¨ Ø¬Ù„Ø¯ Ø´Ø±ÙƒØ§Øª", "Ø¬Ø±Ø§Ø¨ 4k", "Ø¬Ø±Ø§Ø¨ Ø¨Ø§Ù…Ø¨ Ù…Ø±Ø¨Ø¹Ø§Øª", "Ø¬Ø±Ø§Ø¨ Ø¨Ø§Ù…Ø¨ Ø­Ø±ÙŠÙ…ÙŠ", 
      "Ø¬Ø±Ø§Ø¨ Ø´ÙØ§Ù Ø¬Ø¯ÙŠØ¯", "Ø¬Ø±Ø§Ø¨ Ù„ÙŠØ²Ø±", "Ø¬Ø±Ø§Ø¨ Ù…Ø¶Ù„Ø¹", "Ø¬Ø±Ø§Ø¨ Ø¹Ø¯Ø³Ù‡ ÙˆØ§ÙŠØ± Ù„ÙŠØ³", 
      "Ø¬Ø±Ø§Ø¨ ÙˆØ´ ÙˆØ¸Ù‡Ø±", "Ø¬Ø±Ø§Ø¨ ÙƒÙŠØ§Ù‡"
    ],
    "Ø£Ø³ÙƒØ±ÙŠÙ†Ø§Øª": [
      "Ø§Ø³ÙƒØ±ÙŠÙ† ØºÙˆØ±ÙŠÙ„Ø§", "Ø§Ø³ÙƒØ±ÙŠÙ† Ø§ØªØ´ Ø¯ÙŠ hd", "Ø§Ø³ÙƒØ±ÙŠÙ† ÙØ§Ù…ÙŠÙ‡", "Ø§Ø³ÙƒØ±ÙŠÙ† Ù‚Ø·Ù‡", 
      "Ø§Ø³ÙƒØ±ÙŠÙ† Ø§Ù„Ùƒ", "Ø§Ø³ÙƒØ±ÙŠÙ† 360", "Ø§Ø³ÙƒØ±ÙŠÙ†Ø© ØºØ²Ø§Ù„Ù‡", "Ø§Ø³ÙƒØ±ÙŠÙ† Ø§Ù„ØªØ±Ø§", "Ø§Ø³ÙƒØ±ÙŠÙ† ØªØ§Ø¨ Ù…Ø¯Ø§Ø±Ø³"
    ],
    "Ø³Ù…Ø§Ø¹Ø§Øª": [
      "Ø³Ù…Ø§Ø¹Ù‡ p47", "Ø³Ù…Ø§Ø¹Ù‡ ØµÙˆØ¯Ùˆ", "Ø³Ù…Ø§Ø¹Ù‡ p9", "Ø³Ù…Ø§Ø¹Ù‡ cx211", "Ø³Ù…Ø§Ø¹Ù‡ j510", 
      "Ø³Ù…Ø§Ø¹Ù‡ ÙŠØ§Ø³ÙˆÙ†", "Ø³Ù…Ø§Ø¹Ù‡ Ø§Ù„Ùƒ Ù…Ø´ÙƒÙ„", "Ø³Ù…Ø§Ø¹Ù‡ t3+t5", "Ø³Ù…Ø§Ø¹Ù‡ t8+t10", 
      "Ø³Ù…Ø§Ø¹Ù‡ Ø§ÙŠØ±Ø¨ÙˆØ¯ Ø¨Ø±Ùˆ", "Ø³Ù…Ø§Ø¹Ù‡ m10", "Ø³Ù…Ø§Ø¹Ù‡ ÙŠØ§Ø³ÙˆÙ†", "Ø³Ù…Ø§Ø¹Ù‡ ØªØ§ÙŠØ¨ Ø³ÙŠ", 
      "Ø³Ù…Ø§Ø¹Ù‡ Ø§ÙŠÙÙˆÙ† Ø¨Ù„ÙˆØªÙˆØ«", "Ø³Ù…Ø§Ø¹Ù‡ Ø§ÙŠÙÙˆÙ† Ù…Ø¨Ø§Ø´Ø±", "Ø³Ù…Ø§Ø¹Ø© ÙÙ„Ø§Ø´Ø©"
    ],
    "ÙÙ„Ø§Ø´Ø§Øª": [
      "ÙÙ„Ø§Ø´Ø© 8", "ÙÙ„Ø§Ø´Ø© 16", "ÙÙ„Ø§Ø´Ø© 4", "ÙÙ„Ø§Ø´Ø© 32", "ÙÙ„Ø§Ø´Ù‡ 64", "ÙÙ„Ø§Ø´Ù‡ 128"
    ],
    "Ù…ÙˆÙ…Ø±ÙŠ": [
      "Ù…ÙˆÙ…Ø±ÙŠ Ø§ØµÙ„ÙŠ 4", "Ù…ÙˆÙ…Ø±ÙŠ Ø§ØµÙ„ÙŠ 8", "Ù…ÙˆÙ…Ø±ÙŠ Ø§ØµÙ„ÙŠ 16", "Ù…ÙˆÙ…Ø±ÙŠ Ø§ØµÙ„ÙŠ 32", 
      "Ù…ÙˆÙ…Ø±ÙŠ Ø§ØµÙ„ÙŠ 64", "Ù…ÙˆÙ…Ø±ÙŠ Ø§ØµÙ„ÙŠ 128"
    ],
    "Ø¨Ø·Ø§Ø±ÙŠØ§Øª": [
      "Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ùƒ 1000 Ø§Ù…Ø¨ÙŠØ±", "ØµØ¨112", "ØµØ¨ 113", "ØµØ¨ 125", "ØµØ¨"
    ]
  };

  // Load or defaults
  let categories = JSON.parse(localStorage.getItem(KEY_CATEGORIES)) || defaultCategories;
  let items = JSON.parse(localStorage.getItem(KEY_ITEMS)) || [];
  let shops = JSON.parse(localStorage.getItem(KEY_SHOPS)) || ["Ù…Ø­Ù„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡","Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª Ø§Ù„Ø¹ØµØ±ÙŠ"];
  let records = JSON.parse(localStorage.getItem(KEY_DATA)) || [];
  let filteredRecords = [...records];
  let currentCategory = Object.keys(categories)[0]; // Default to first category

  // DOM
  const itemsArea = document.getElementById('itemsArea');
  const shopsArea = document.getElementById('shopsArea');
  const recordsTbody = document.querySelector('#recordsTable tbody');
  const notification = document.getElementById('notification');
  const filterSection = document.getElementById('filterSection');
  const toggleFilter = document.getElementById('toggleFilter');
  const statsContainer = document.getElementById('statsContainer');
  const categoryTabs = document.getElementById('categoryTabs');

  const newItemInput = document.getElementById('newItemInput');
  const addItemBtn = document.getElementById('addItemBtn');
  const newShopInput = document.getElementById('newShopInput');
  const addShopBtn = document.getElementById('addShopBtn');

  const entry_item = document.getElementById('entry_item');
  const entry_qty  = document.getElementById('entry_qty');
  const entry_shop = document.getElementById('entry_shop');

  const saveBtn = document.getElementById('saveBtn');
  const saveNewBtn = document.getElementById('saveNewBtn');
  const exportCsv = document.getElementById('exportCsv');
  const clearAll = document.getElementById('clearAll');

  // Filter elements
  const filterItem = document.getElementById('filterItem');
  const filterShop = document.getElementById('filterShop');
  const filterQty = document.getElementById('filterQty');
  const applyFilter = document.getElementById('applyFilter');
  const clearFilter = document.getElementById('clearFilter');

  // Edit state
  let editIndex = -1;
  let selectedItemIndex = -1;
  let selectedShopIndex = -1;

  // Notification function
  function showNotification(message, type = 'success', duration = 3000) {
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.opacity = '1';
    
    setTimeout(() => {
      notification.style.opacity = '0';
    }, duration);
  }

  // Update statistics
  function updateStats() {
    const totalRecords = records.length;
    const totalItems = Object.values(categories).flat().length;
    const totalShops = shops.length;
    
    statsContainer.innerHTML = `
      <div class="stat-box">
        <div class="stat-value">${totalRecords}</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">${totalItems}</div>
        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">${totalShops}</div>
        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
      </div>
    `;
  }

  // Render categories
  function renderCategories() {
    categoryTabs.innerHTML = '';
    
    Object.keys(categories).forEach(category => {
      const tab = document.createElement('div');
      tab.className = `category-tab ${currentCategory === category ? 'active' : ''}`;
      tab.textContent = category;
      tab.dataset.category = category;
      categoryTabs.appendChild(tab);
    });
    
    // Add event listeners for category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        currentCategory = tab.dataset.category;
        renderCategories();
        renderItems();
      });
    });
  }

  // Render functions
  function renderItems(){
    itemsArea.innerHTML = '';
    
    const categoryItems = categories[currentCategory] || [];
    
    if (categoryItems.length === 0) {
      itemsArea.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø¶Ø§ÙØ©</div>';
      return;
    }
    
    categoryItems.forEach((name, idx) => {
      const div = document.createElement('div');
      div.className = `item-btn ${selectedItemIndex === idx ? 'selected' : ''}`;
      div.dataset.idx = idx;
      div.dataset.type = 'item';
      div.innerHTML = `<span style="flex:1;text-align:right">${escapeHtml(name)}</span>
                       <div style="display:flex;gap:8px">
                         <button class="small-btn edit" data-category="${currentCategory}" data-i="${idx}" data-type="edit-item">ØªØ¹Ø¯ÙŠÙ„</button>
                         <button class="small-btn" data-category="${currentCategory}" data-i="${idx}" data-type="del-item">Ø­Ø°Ù</button>
                       </div>`;
      itemsArea.appendChild(div);
    });
  }

  function renderShops(){
    shopsArea.innerHTML = '';
    
    if (shops.length === 0) {
      shopsArea.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…Ø¶Ø§ÙØ©</div>';
      return;
    }
    
    shops.forEach((name, idx) => {
      const div = document.createElement('div');
      div.className = `item-btn ${selectedShopIndex === idx ? 'selected' : ''}`;
      div.dataset.idx = idx;
      div.dataset.type = 'shop';
      div.innerHTML = `<span style="flex:1;text-align:right">${escapeHtml(name)}</span>
                       <div style="display:flex;gap:8px">
                         <button class="small-btn edit" data-i="${idx}" data-type="edit-shop">ØªØ¹Ø¯ÙŠÙ„</button>
                         <button class="small-btn" data-i="${idx}" data-type="del-shop">Ø­Ø°Ù</button>
                       </div>`;
      shopsArea.appendChild(div);
    });
  }

  function renderRecords(){
    recordsTbody.innerHTML = '';
    
    if (filteredRecords.length === 0) {
      recordsTbody.innerHTML = '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
      return;
    }
    
    filteredRecords.forEach((r, idx) => {
      const originalIndex = records.findIndex(record => 
        record.time === r.time && record.item === r.item && 
        record.qty === r.qty && record.shop === r.shop
      );
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.time}</td>
                      <td>${escapeHtml(r.item)}</td>
                      <td>${escapeHtml(r.qty)}</td>
                      <td>${escapeHtml(r.shop)}</td>
                      <td>
                        <button class="action-btn action-edit" data-i="${originalIndex}" data-act="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="action-btn action-del" data-i="${originalIndex}" data-act="del">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                      </td>`;
      recordsTbody.appendChild(tr);
    });
  }

  // Helpers
  function saveCategories() { 
    localStorage.setItem(KEY_CATEGORIES, JSON.stringify(categories)); 
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    updateStats();
  }
  
  function saveItems(){ 
    localStorage.setItem(KEY_ITEMS, JSON.stringify(items)); 
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ù†Ø¬Ø§Ø­');
    updateStats();
  }
  
  function saveShops(){ 
    localStorage.setItem(KEY_SHOPS, JSON.stringify(shops)); 
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    updateStats();
  }
  
  function saveRecords(){ 
    localStorage.setItem(KEY_DATA, JSON.stringify(records)); 
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    updateStats();
  }

  function escapeHtml(s){ 
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
  }

  function applyFilters() {
    filteredRecords = records.filter(record => {
      const itemMatch = !filterItem.value || record.item.toLowerCase().includes(filterItem.value.toLowerCase());
      const shopMatch = !filterShop.value || record.shop.toLowerCase().includes(filterShop.value.toLowerCase());
      const qtyMatch = !filterQty.value || record.qty == filterQty.value;
      
      return itemMatch && shopMatch && qtyMatch;
    });
    
    renderRecords();
  }

  // Initial render
  renderCategories();
  renderItems();
  renderShops();
  renderRecords();
  updateStats();

  // Delegated click handling for items & shops (select/delete/edit)
  document.addEventListener('click', (e) => {
    const t = e.target;
    const type = t.dataset.type;
    const i = t.dataset.i;
    const category = t.dataset.category;
    
    // Check if user clicked on the main button area (not the small buttons)
    if (t.classList.contains('item-btn') || t.parentElement.classList.contains('item-btn')) {
      const itemBtn = t.classList.contains('item-btn') ? t : t.parentElement;
      const itemType = itemBtn.dataset.type;
      const itemIdx = itemBtn.dataset.idx;
      
      if (itemType === 'item') {
        // Select item
        selectedItemIndex = parseInt(itemIdx);
        const name = categories[currentCategory][selectedItemIndex];
        entry_item.value = name;
        renderItems(); // Re-render to update selection
        entry_qty.focus();
        showNotification(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ†Ù: ${name}`, 'success', 2000);
      } else if (itemType === 'shop') {
        // Select shop
        selectedShopIndex = parseInt(itemIdx);
        const name = shops[selectedShopIndex];
        entry_shop.value = name;
        renderShops(); // Re-render to update selection
        entry_qty.focus();
        showNotification(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ù„: ${name}`, 'success', 2000);
      }
      return;
    }
    
    if(!type) return;

    if(type === 'del-item'){
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')){
        categories[category].splice(+i,1);
        saveCategories(); 
        renderItems();
        showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­');
      }
    } else if(type === 'edit-item'){
      const newName = prompt('Ø¹Ø¯Ù‘Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:', categories[category][+i]);
      if(newName && newName.trim()){
        categories[category][+i] = newName.trim();
        saveCategories(); 
        renderItems();
        showNotification('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­');
      }
    } else if(type === 'del-shop'){
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ù„ØŸ')){
        shops.splice(+i,1);
        saveShops(); 
        renderShops();
        showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      }
    } else if(type === 'edit-shop'){
      const newName = prompt('Ø¹Ø¯Ù‘Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„:', shops[+i]);
      if(newName && newName.trim()){
        shops[+i] = newName.trim();
        saveShops(); 
        renderShops();
        showNotification('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      }
    }
  });

  // Add item/shop
  addItemBtn.addEventListener('click', () => {
    const v = newItemInput.value.trim();
    if(!v) {
      showNotification('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©', 'warning');
      newItemInput.focus();
      return;
    }
    
    // Check if item exists in any category
    let exists = false;
    Object.values(categories).forEach(catItems => {
      if(catItems.includes(v)) exists = true;
    });
    
    if(exists) {
      showNotification('Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
      return;
    }
    
    // Add to current category
    if(!categories[currentCategory]) {
      categories[currentCategory] = [];
    }
    categories[currentCategory].push(v); 
    saveCategories(); 
    renderItems(); 
    newItemInput.value=''; 
    newItemInput.focus();
    showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­');
  });
  
  newItemInput.addEventListener('keydown', (e)=> { 
    if(e.key==='Enter') addItemBtn.click(); 
  });

  addShopBtn.addEventListener('click', () => {
    const v = newShopInput.value.trim();
    if(!v) {
      showNotification('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©', 'warning');
      newShopInput.focus();
      return;
    }
    
    if(shops.includes(v)) {
      showNotification('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
      return;
    }
    
    shops.push(v); 
    saveShops(); 
    renderShops(); 
    newShopInput.value=''; 
    newShopInput.focus();
    showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­');
  });
  
  newShopInput.addEventListener('keydown', (e)=> { 
    if(e.key==='Enter') addShopBtn.click(); 
  });

  // Save record (new or update)
  function clearInputs(){
    entry_item.value=''; 
    entry_qty.value=1; 
    entry_shop.value=''; 
    selectedItemIndex = -1;
    selectedShopIndex = -1;
    renderItems();
    renderShops();
    entry_item.focus();
  }

  function switchToEditMode(idx){
    editIndex = idx;
    saveBtn.textContent = 'âœï¸ ØªØ­Ø¯ÙŠØ«';
    saveBtn.className = 'save';
    saveNewBtn.textContent = 'âŒ Ø¥Ù„ØºØ§Ø¡';
    saveNewBtn.className = 'cancel';
  }

  function switchToAddMode(){
    editIndex = -1;
    saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸';
    saveBtn.className = 'save';
    saveNewBtn.textContent = 'ğŸ’¾â• Ø­ÙØ¸ + Ø¬Ø¯ÙŠØ¯';
    saveNewBtn.className = '';
  }

  saveBtn.addEventListener('click', () => {
    const item = entry_item.value.trim();
    const qty  = entry_qty.value;
    const shop = entry_shop.value.trim();

    if(!item || !qty || !shop){ 
      showNotification('Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª', 'warning');
      return; 
    }

    if(editIndex === -1){
      // new
      records.push({ time: new Date().toLocaleString('ar-EG'), item, qty, shop });
      saveRecords(); 
      applyFilters();
      clearInputs();
      showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
    } else {
      // update
      records[editIndex] = { ...records[editIndex], item, qty, shop };
      saveRecords(); 
      applyFilters();
      clearInputs(); 
      switchToAddMode();
      showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
    }
  });

  saveNewBtn.addEventListener('click', () => {
    if(editIndex === -1){
      // save + new
      saveBtn.click();
      // keep item to blank for new entry
    } else {
      // cancel edit
      if(confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ')) { 
        clearInputs(); 
        switchToAddMode(); 
        showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'warning');
      }
    }
  });

  // Edit / Delete record actions (delegation)
  recordsTbody.addEventListener('click', (e) => {
    const btn = e.target;
    const act = btn.dataset.act;
    const i = btn.dataset.i;
    if(!act) return;

    if(act === 'edit'){
      const r = records[+i];
      entry_item.value = r.item;
      entry_qty.value = r.qty;
      entry_shop.value = r.shop;
      switchToEditMode(+i);
      showNotification('ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„', 'success', 2000);
    } else if(act === 'del'){
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')){
        records.splice(+i,1);
        saveRecords(); 
        applyFilters();
        showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      }
    }
  });

  // Export CSV
  exportCsv.addEventListener('click', () => {
    if(records.length === 0) {
      showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
      return;
    }
    
    const header = ['Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„ØµÙ†Ù','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ù…Ø­Ù„'];
    const rows = records.map(r => [r.time, r.item, r.qty, r.shop]);
    const lines = [header, ...rows].map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob(["\uFEFF" + lines], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `selaf_data_${new Date().toISOString().slice(0,10)}.csv`; 
    document.body.appendChild(a); 
    a.click(); 
    a.remove(); 
    URL.revokeObjectURL(url);
    showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  });

  // Clear all records
  clearAll.addEventListener('click', () => {
    if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')){ 
      records=[]; 
      saveRecords(); 
      applyFilters(); 
      showNotification('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'warning');
    }
  });

  // Filter functionality
  toggleFilter.addEventListener('click', () => {
    filterSection.style.display = filterSection.style.display === 'none' ? 'block' : 'none';
    toggleFilter.textContent = filterSection.style.display === 'none' ? 'ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª' : 'âŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØµÙÙŠØ©';
  });

  applyFilter.addEventListener('click', () => {
    applyFilters();
    showNotification('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©');
  });

  clearFilter.addEventListener('click', () => {
    filterItem.value = '';
    filterShop.value = '';
    filterQty.value = '';
    filteredRecords = [...records];
    renderRecords();
    showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµÙÙŠØ©');
  });

  // Auto-apply filter when typing
  [filterItem, filterShop, filterQty].forEach(input => {
    input.addEventListener('input', () => {
      // Apply filter after a short delay to avoid excessive filtering
      clearTimeout(window.filterTimeout);
      window.filterTimeout = setTimeout(applyFilters, 500);
    });
  });

  // Prevent accidental form submission on Enter when focus in inputs (optional UX)
  [entry_item, entry_qty, entry_shop].forEach(inp => {
    inp.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        // move focus sequentially
        if(document.activeElement === entry_item) {
          entry_qty.focus();
          entry_qty.style.transform = 'scale(1.02)';
          setTimeout(() => {
            entry_qty.style.transform = 'scale(1)';
          }, 200);
        }
        else if(document.activeElement === entry_qty) {
          entry_shop.focus();
          entry_shop.style.transform = 'scale(1.02)';
          setTimeout(() => {
            entry_shop.style.transform = 'scale(1)';
          }, 200);
        }
        else if(document.activeElement === entry_shop) saveBtn.click();
      }
    });
  });

  // Auto-save on page unload
  window.addEventListener('beforeunload', () => {
    saveCategories();
    saveShops();
    saveRecords();
  });

</script>
</body>
</html>
