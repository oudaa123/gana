<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>كراسة اليومية</title>
<style>
  :root {
    --accent:#6ed0ff;
    --btn:#ff9ad1;
    --done:#d8d8d8;
    --pending:#fff7a5;
    --warning:#ffcccc;
    --active:#4CAF50;
  }

  body {
    font-family: Tahoma, Arial;
    background: #e8f8ff;
    margin: 0;
    padding: 10px;
  }

  h2 {
    text-align: center;
    margin-bottom: 5px;
    color: #004466;
  }

  #datetime {
    text-align: center;
    font-size: 14px;
    color: #333;
    margin-bottom: 5px;
  }

  #currentDateDisplay {
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    color: #004466;
    margin-bottom: 10px;
    padding: 5px;
    background-color: #d8f0ff;
    border-radius: 5px;
  }

  #topBar {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }

  .inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: center;
  }

  input, button {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
  }

  input {
    flex: 1 1 120px;
  }

  button {
    background: var(--btn);
    color: #000;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
  }

  button:hover {
    background: #ff7ec5;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }

  th {
    background: var(--accent);
  }

  tr.done td {
    text-decoration: line-through;
    color: red;
    background: var(--done);
  }

  tr.pending td {
    background: var(--pending);
  }

  .day-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
    justify-content: center;
  }

  .day-buttons button {
    background: var(--accent);
    border: none;
  }

  .day-buttons button.active {
    background: var(--active);
    color: white;
    font-weight: bold;
  }

  .warning {
    background-color: var(--warning) !important;
  }

  @media (max-width:600px){
    input {flex:1 1 45%;}
    button{flex:1 1 45%;}
  }
</style>
</head>
<body>

<h2>📘 كراسة اليومية</h2>
<div id="datetime"></div>
<div id="currentDateDisplay"></div>

<div id="topBar">
  <button onclick="confirmDeleteAll()">🗑️ حذف جميع البيانات</button>
  <button onclick="confirmDeleteWeek()">🧹 حذف بيانات الأسبوع</button>
</div>

<div class="inputs">
  <input type="text" id="person" placeholder="الاسم">
  <input type="text" id="item" placeholder="الصنف">
  <input type="number" id="qty" placeholder="الكمية">
  <input type="number" id="price" placeholder="السعر (اختياري)">
  <input type="text" id="receiver" placeholder="المستلم (يتعبأ تلقائياً)">
  <button id="addBtn">➕ إضافة</button>
</div>

<div class="day-buttons" id="dayButtons"></div>

<table>
  <thead>
    <tr>
      <th>الاسم</th>
      <th>الصنف</th>
      <th>الكمية</th>
      <th>السعر</th>
      <th>المستلم</th>
      <th>النتيجة</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
let dailyRecords = JSON.parse(localStorage.getItem("dailyRecords") || "{}");
let lastKnownDate = getTodayDate(); // تتبع آخر تاريخ معروف
const inputs = document.querySelectorAll("input");

// الحصول على تاريخ اليوم بصيغة YYYY-MM-DD (التوقيت المحلي)
function getTodayDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// تحويل تاريخ من صيغة YYYY-MM-DD إلى تاريخ عربي
function formatArabicDate(dateString) {
  const date = new Date(dateString + 'T12:00:00');
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ar-EG', options);
}

// حساب الفرق بين تاريخين بالأيام
function getDaysDifference(date1, date2) {
  const oneDay = 24 * 60 * 60 * 1000;
  const firstDate = new Date(date1);
  const secondDate = new Date(date2);
  const diffDays = Math.round(Math.abs((firstDate - secondDate) / oneDay));
  return diffDays;
}

// التحقق من تغيير اليوم وتحديث البيانات تلقائياً
function checkDateChange() {
  const today = getTodayDate();
  
  // إذا تغير اليوم
  if (today !== lastKnownDate) {
    console.log('تم تغيير اليوم من', lastKnownDate, 'إلى', today);
    lastKnownDate = today;
    
    // تحديث الواجهة لعرض بيانات اليوم الجديد
    renderDayButtons();
    renderTable(today);
    
    // إشعار للمستخدم بأن اليوم تغير
    showDateChangeNotification();
  }
}

// عرض إشعار تغيير اليوم
function showDateChangeNotification() {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--active);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    z-index: 1000;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideDown 0.5s ease;
  `;
  
  notification.textContent = `🎉 تم الانتقال تلقائياً إلى بيانات يوم ${formatArabicDate(getTodayDate())}`;
  
  document.body.appendChild(notification);
  
  // إزالة الإشعار بعد 3 ثواني
  setTimeout(() => {
    notification.style.animation = 'slideUp 0.5s ease';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 500);
  }, 3000);
}

// إضافة أنيميشن للإشعار
const style = document.createElement('style');
style.textContent = `
  @keyframes slideDown {
    from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
  }
  @keyframes slideUp {
    from { transform: translateX(-50%) translateY(0); opacity: 1; }
    to { transform: translateX(-50%) translateY(-100px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// 🕒 تحديث التاريخ والساعة والتحقق من تغيير اليوم
function updateDateTime() {
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const dateStr = now.toLocaleDateString('ar-EG', options);
  const timeStr = now.toLocaleTimeString('ar-EG');
  document.getElementById("datetime").textContent = `🕒 ${dateStr} - ${timeStr}`;
  
  // التحقق من تغيير اليوم
  checkDateChange();
  
  // تحديث العرض دائماً لبيانات اليوم الحالي
  updateCurrentDateDisplay();
}

// تحديث عرض التاريخ الحالي للبيانات المعروضة
function updateCurrentDateDisplay() {
  const today = getTodayDate();
  const dateStr = formatArabicDate(today);
  
  let displayText = `📅 البيانات المعروضة ليوم: ${dateStr}`;
  
  document.getElementById("currentDateDisplay").innerHTML = displayText;
}

setInterval(updateDateTime, 1000);
updateDateTime();

// ⌨️ التنقل بين الخانات بالـ Enter
inputs.forEach((input, i) => {
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const next = inputs[i + 1];
      if (next) next.focus();
      else document.getElementById("addBtn").click();
    }
  });
});

// 🧭 عرض أزرار الأيام
function renderDayButtons() {
  const dayButtons = document.getElementById("dayButtons");
  dayButtons.innerHTML = "";
  
  const today = getTodayDate();
  
  // إضافة زر اليوم الحالي أولاً
  const todayBtn = document.createElement("button");
  todayBtn.textContent = "اليوم الحالي";
  todayBtn.onclick = () => {
    renderTable(today);
    updateCurrentDateDisplay();
    renderDayButtons();
  };
  todayBtn.classList.add("active"); // دائمًا نشط لأنه يعرض اليوم الحالي
  dayButtons.appendChild(todayBtn);
  
  // عرض أزرار الأيام الأخرى (التاريخ فقط بدون زر تفاعلي)
  Object.keys(dailyRecords)
    .sort()
    .reverse()
    .forEach(date => {
      if (date !== today) {
        const btn = document.createElement("button");
        const displayDate = formatArabicDate(date);
        btn.textContent = displayDate.split('، ')[1];
        btn.title = displayDate;
        btn.onclick = () => {
          // عند النقر على يوم آخر، نعود تلقائياً لليوم الحالي بعد ثانيتين
          renderTable(date);
          setTimeout(() => {
            renderTable(today);
            alert(`تم عرض بيانات ${displayDate} مؤقتاً. العودة لبيانات اليوم الحالي.`);
          }, 2000);
        };
        dayButtons.appendChild(btn);
      }
    });
}

// 📋 عرض جدول اليوم المحدد
function renderTable(date) {
  const table = document.getElementById("tableBody");
  table.innerHTML = "";
  const records = dailyRecords[date] || [];
  
  if (records.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="text-align:center; padding:20px;">لا توجد بيانات لهذا اليوم</td>`;
    table.appendChild(tr);
  } else {
    records.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.classList.add(r.returned ? "done" : "pending");
      tr.innerHTML = `
        <td>${r.person}</td>
        <td>${r.item}</td>
        <td>${r.qty || ""}</td>
        <td>${r.price || ""}</td>
        <td>${r.receiver}</td>
        <td><button onclick="toggleReturn('${date}',${i})">${r.returned ? "تم الإرجاع" : "النتيجة"}</button></td>
      `;
      table.appendChild(tr);
    });
  }
  
  updateCurrentDateDisplay();
}

// 🔁 تبديل حالة الإرجاع
function toggleReturn(date, index) {
  const record = dailyRecords[date][index];
  if (!record.returned) {
    record.returned = true;
  } else {
    if (confirm(`هل أنت متأكد أن "${record.person}" لم يرجع؟`)) {
      const pass = prompt("من فضلك أدخل كلمة السر:");
      if (pass === "888") record.returned = false;
      else return alert("كلمة السر غير صحيحة!");
    }
  }
  saveData();
  renderTable(getTodayDate()); // العودة دائمًا لبيانات اليوم الحالي
}

// 💾 حفظ البيانات
function saveData() {
  localStorage.setItem("dailyRecords", JSON.stringify(dailyRecords));
  renderDayButtons();
}

// ➕ إضافة بيانات جديدة
document.getElementById("addBtn").onclick = () => {
  const person = document.getElementById("person").value.trim();
  const item = document.getElementById("item").value.trim();
  const qty = document.getElementById("qty").value.trim();
  const price = document.getElementById("price").value.trim();
  let receiver = document.getElementById("receiver").value.trim();

  if (!person || !item) return alert("يرجى إدخال الاسم والصنف على الأقل");
  if (!receiver) receiver = person;

  // إضافة البيانات ليوم اليوم الحالي دائماً
  const today = getTodayDate();
  if (!dailyRecords[today]) dailyRecords[today] = [];
  dailyRecords[today].push({ person, item, qty, price, receiver, returned: false });
  saveData();
  
  // عرض بيانات اليوم الحالي
  renderTable(today);

  document.querySelectorAll("input").forEach(i => i.value = "");
  document.getElementById("person").focus();
};

// 🧹 حذف بيانات الأسبوع بباسورد
function confirmDeleteWeek() {
  if (confirm("هل أنت متأكد من حذف بيانات الأسبوع؟ سيتم حذف جميع البيانات الأقدم من 7 أيام.")) {
    const pass = prompt("من فضلك أدخل كلمة السر:");
    if (pass === "888") {
      const today = getTodayDate();
      let deletedCount = 0;
      
      const dates = Object.keys(dailyRecords);
      
      dates.forEach(date => {
        const daysDifference = getDaysDifference(today, date);
        if (daysDifference > 7) {
          delete dailyRecords[date];
          deletedCount++;
        }
      });
      
      saveData();
      
      if (deletedCount > 0) {
        alert(`تم حذف ${deletedCount} يوم من البيانات القديمة بنجاح ✅`);
      } else {
        alert("لا توجد بيانات أقدم من 7 أيام لحذفها");
      }
      
      renderTable(today);
    } else {
      alert("كلمة السر غير صحيحة!");
    }
  }
}

// 🗑️ حذف جميع البيانات
function confirmDeleteAll() {
  if (confirm("هل أنت متأكد من حذف جميع البيانات؟")) {
    const hasPending = Object.values(dailyRecords).some(records => 
      records.some(record => !record.returned)
    );
    
    if (hasPending) {
      const confirmDelete = confirm("⚠️ تحذير: هناك أشخاص لم يسددوا بعد. هل تريد المتابعة مع حذف جميع البيانات؟");
      if (!confirmDelete) return;
    }
    
    const pass = prompt("من فضلك أدخل كلمة السر:");
    if (pass === "888") {
      dailyRecords = {};
      saveData();
      alert("تم حذف جميع البيانات بنجاح ✅");
      renderTable(getTodayDate());
    } else {
      alert("كلمة السر غير صحيحة!");
    }
  }
}

// 🟢 تحميل البيانات الافتراضية - دائماً نبدأ ببيانات اليوم الحالي
renderDayButtons();
renderTable(getTodayDate());
</script>

</body>
</html>
