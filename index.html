<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙƒØ±Ø§Ø³Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</title>
<style>
  :root {
    --accent:#6ed0ff;
    --btn:#ff9ad1;
    --done:#d8d8d8;
    --pending:#fff7a5;
    --warning:#ffcccc;
    --active:#4CAF50;
  }

  body {
    font-family: Tahoma, Arial;
    background: #e8f8ff;
    margin: 0;
    padding: 10px;
  }

  h2 {
    text-align: center;
    margin-bottom: 5px;
    color: #004466;
  }

  #datetime {
    text-align: center;
    font-size: 14px;
    color: #333;
    margin-bottom: 5px;
  }

  #currentDateDisplay {
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    color: #004466;
    margin-bottom: 10px;
    padding: 5px;
    background-color: #d8f0ff;
    border-radius: 5px;
  }

  #topBar {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }

  .inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: center;
  }

  input, button {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
  }

  input {
    flex: 1 1 120px;
  }

  button {
    background: var(--btn);
    color: #000;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
  }

  button:hover {
    background: #ff7ec5;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }

  th {
    background: var(--accent);
  }

  tr.done td {
    text-decoration: line-through;
    color: red;
    background: var(--done);
  }

  tr.pending td {
    background: var(--pending);
  }

  .day-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
    justify-content: center;
  }

  .day-buttons button {
    background: var(--accent);
    border: none;
  }

  .day-buttons button.active {
    background: var(--active);
    color: white;
    font-weight: bold;
  }

  .warning {
    background-color: var(--warning) !important;
  }

  @media (max-width:600px){
    input {flex:1 1 45%;}
    button{flex:1 1 45%;}
  }
</style>
</head>
<body>

<h2>ğŸ“˜ ÙƒØ±Ø§Ø³Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
<div id="datetime"></div>
<div id="currentDateDisplay"></div>

<div id="topBar">
  <button onclick="confirmDeleteAll()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  <button onclick="confirmDeleteWeek()">ğŸ§¹ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
</div>

<div class="inputs">
  <input type="text" id="person" placeholder="Ø§Ù„Ø§Ø³Ù…">
  <input type="text" id="item" placeholder="Ø§Ù„ØµÙ†Ù">
  <input type="number" id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  <input type="number" id="price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <input type="text" id="receiver" placeholder="Ø§Ù„Ù…Ø³ØªÙ„Ù… (ÙŠØªØ¹Ø¨Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)">
  <button id="addBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>

<div class="day-buttons" id="dayButtons"></div>

<table>
  <thead>
    <tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„ØµÙ†Ù</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
      <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
let dailyRecords = JSON.parse(localStorage.getItem("dailyRecords") || "{}");
let currentDisplayDate = getTodayDate();
let lastKnownDate = getTodayDate();
const inputs = document.querySelectorAll("input");

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¨ØµÙŠØºØ© YYYY-MM-DD (Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…Ø­Ù„ÙŠ)
function getTodayDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ù…Ù† ØµÙŠØºØ© YYYY-MM-DD Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø¹Ø±Ø¨ÙŠ
function formatArabicDate(dateString) {
  const date = new Date(dateString + 'T12:00:00');
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ar-EG', options);
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ† Ø¨Ø§Ù„Ø£ÙŠØ§Ù…
function getDaysDifference(date1, date2) {
  const oneDay = 24 * 60 * 60 * 1000;
  const firstDate = new Date(date1);
  const secondDate = new Date(date2);
  const diffDays = Math.round(Math.abs((firstDate - secondDate) / oneDay));
  return diffDays;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ… ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function checkDateChange() {
  const today = getTodayDate();
  
  // Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„ÙŠÙˆÙ… ÙˆÙ†Ø­Ù† Ù†Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
  if (today !== lastKnownDate && currentDisplayDate === lastKnownDate) {
    console.log('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ… Ù…Ù†', lastKnownDate, 'Ø¥Ù„Ù‰', today);
    lastKnownDate = today;
    currentDisplayDate = today; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    renderDayButtons();
    renderTable(today);
  }
}

// ğŸ•’ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ…
function updateDateTime() {
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const dateStr = now.toLocaleDateString('ar-EG', options);
  const timeStr = now.toLocaleTimeString('ar-EG');
  document.getElementById("datetime").textContent = `ğŸ•’ ${dateStr} - ${timeStr}`;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ…
  checkDateChange();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
  updateCurrentDateDisplay();
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
function updateCurrentDateDisplay() {
  const dateStr = formatArabicDate(currentDisplayDate);
  
  let displayText = `ğŸ“… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„ÙŠÙˆÙ…: ${dateStr}`;
  
  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø±Ø¶ ÙŠÙˆÙ… Ø¢Ø®Ø±
  if (currentDisplayDate !== getTodayDate()) {
    displayText += ` <button onclick="showToday()" style="margin-right:10px; padding:3px 8px; font-size:12px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</button>`;
  }
  
  document.getElementById("currentDateDisplay").innerHTML = displayText;
}

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø·)
function showToday() {
  currentDisplayDate = getTodayDate();
  updateCurrentDateDisplay();
  renderDayButtons();
  renderTable(currentDisplayDate);
}

setInterval(updateDateTime, 1000);
updateDateTime();

// âŒ¨ï¸ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¨Ø§Ù„Ù€ Enter
inputs.forEach((input, i) => {
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const next = inputs[i + 1];
      if (next) next.focus();
      else document.getElementById("addBtn").click();
    }
  });
});

// ğŸ§­ Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù…
function renderDayButtons() {
  const dayButtons = document.getElementById("dayButtons");
  dayButtons.innerHTML = "";
  
  const today = getTodayDate();
  
  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
  const todayBtn = document.createElement("button");
  todayBtn.textContent = "Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ";
  todayBtn.onclick = () => {
    currentDisplayDate = today;
    renderTable(today);
    updateCurrentDateDisplay();
    renderDayButtons();
  };
  if (currentDisplayDate === today) {
    todayBtn.classList.add("active");
  }
  dayButtons.appendChild(todayBtn);
  
  // Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
  Object.keys(dailyRecords)
    .sort()
    .reverse()
    .forEach(date => {
      if (date !== today) {
        const btn = document.createElement("button");
        const displayDate = formatArabicDate(date);
        btn.textContent = displayDate.split('ØŒ ')[1];
        btn.title = displayDate;
        
        btn.onclick = () => {
          currentDisplayDate = date;
          renderTable(date);
          updateCurrentDateDisplay();
          renderDayButtons();
        };
        
        if (date === currentDisplayDate) {
          btn.classList.add("active");
        }
        
        dayButtons.appendChild(btn);
      }
    });
}

// ğŸ“‹ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯
function renderTable(date) {
  currentDisplayDate = date;
  const table = document.getElementById("tableBody");
  table.innerHTML = "";
  const records = dailyRecords[date] || [];
  
  if (records.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</td>`;
    table.appendChild(tr);
  } else {
    records.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.classList.add(r.returned ? "done" : "pending");
      tr.innerHTML = `
        <td>${r.person}</td>
        <td>${r.item}</td>
        <td>${r.qty || ""}</td>
        <td>${r.price || ""}</td>
        <td>${r.receiver}</td>
        <td><button onclick="toggleReturn('${date}',${i})">${r.returned ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹" : "Ø§Ù„Ù†ØªÙŠØ¬Ø©"}</button></td>
      `;
      table.appendChild(tr);
    });
  }
  
  updateCurrentDateDisplay();
}

// ğŸ” ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
function toggleReturn(date, index) {
  const record = dailyRecords[date][index];
  if (!record.returned) {
    record.returned = true;
  } else {
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù† "${record.person}" Ù„Ù… ÙŠØ±Ø¬Ø¹ØŸ`)) {
      const pass = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
      if (pass === "888") record.returned = false;
      else return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
    }
  }
  saveData();
  renderTable(currentDisplayDate); // Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹
}

// ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function saveData() {
  localStorage.setItem("dailyRecords", JSON.stringify(dailyRecords));
  renderDayButtons();
}

// â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
document.getElementById("addBtn").onclick = () => {
  const person = document.getElementById("person").value.trim();
  const item = document.getElementById("item").value.trim();
  const qty = document.getElementById("qty").value.trim();
  const price = document.getElementById("price").value.trim();
  let receiver = document.getElementById("receiver").value.trim();

  if (!person || !item) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙ†Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
  if (!receiver) receiver = person;

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠÙˆÙ… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
  const today = getTodayDate();
  if (!dailyRecords[today]) dailyRecords[today] = [];
  dailyRecords[today].push({ person, item, qty, price, receiver, returned: false });
  saveData();
  
  // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
  if (currentDisplayDate === today) {
    renderTable(today);
  } else {
    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø±Ø¶ ÙŠÙˆÙ… Ø¢Ø®Ø±ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·
    renderDayButtons();
  }

  document.querySelectorAll("input").forEach(i => i.value = "");
  document.getElementById("person").focus();
};

// ğŸ§¹ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¨Ø§Ø³ÙˆØ±Ø¯
function confirmDeleteWeek() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø¯Ù… Ù…Ù† 7 Ø£ÙŠØ§Ù….")) {
    const pass = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
    if (pass === "888") {
      const today = getTodayDate();
      let deletedCount = 0;
      
      const dates = Object.keys(dailyRecords);
      
      dates.forEach(date => {
        const daysDifference = getDaysDifference(today, date);
        if (daysDifference > 7) {
          delete dailyRecords[date];
          deletedCount++;
        }
      });
      
      saveData();
      
      if (deletedCount > 0) {
        alert(`ØªÙ… Ø­Ø°Ù ${deletedCount} ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
      } else {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù‚Ø¯Ù… Ù…Ù† 7 Ø£ÙŠØ§Ù… Ù„Ø­Ø°ÙÙ‡Ø§");
      }
      
      renderTable(currentDisplayDate);
    } else {
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
    }
  }
}

// ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function confirmDeleteAll() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
    const hasPending = Object.values(dailyRecords).some(records => 
      records.some(record => !record.returned)
    );
    
    if (hasPending) {
      const confirmDelete = confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù†Ø§Ùƒ Ø£Ø´Ø®Ø§Øµ Ù„Ù… ÙŠØ³Ø¯Ø¯ÙˆØ§ Ø¨Ø¹Ø¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ");
      if (!confirmDelete) return;
    }
    
    const pass = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
    if (pass === "888") {
      dailyRecords = {};
      saveData();
      alert("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      renderTable(currentDisplayDate);
    } else {
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
    }
  }
}

// ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
renderDayButtons();
renderTable(currentDisplayDate);
</script>

</body>
</html>
